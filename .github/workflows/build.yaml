name: Build

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Set up Java
              uses: actions/setup-java@v5
              with:
                  distribution: "temurin"
                  java-version: "21"
                  cache: "maven"
            - name: Build with Maven
              run: ./mvnw -B package

    integration-tests:
        runs-on: ubuntu-latest
        needs: build
        env:
            SPRING_DATASOURCE_URL: jdbc:mariadb://localhost:3306/employees
            SPRING_DATASOURCE_USERNAME: employees
            SPRING_DATASOURCE_PASSWORD: password
        services:
            mariadb:
                image: mariadb:12.1.1-rc
                env:
                    MARIADB_USER: employees
                    MARIADB_DATABASE: employees
                    MARIADB_PASSWORD: password
                    MARIADB_ROOT_PASSWORD: password
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="healthcheck --connect --innodb_initialized"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3
        steps:
            - run: echo "Run integration tests here"
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Set up Java
              uses: actions/setup-java@v5
              with:
                  distribution: "temurin"
                  java-version: "21"
                  cache: "maven"
            - name: Build with Maven
              run: ./mvnw -B verify

    build-image:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - run: echo "Build Docker images here"

    deploy:
        runs-on: ubuntu-latest
        needs: build-image
        steps:
            - run: echo "Deploy application here"
